# ğŸ§ª TEST PRE-WEB - ENDPOINTS + TABLAS

## âœ… Verificaciones Realizadas

### 1ï¸âƒ£ **Sintaxis Python**
- [x] `python -m py_compile routes/decisiones.py` â†’ âœ… PASS
- [x] Sin errores de compilaciÃ³n

### 2ï¸âƒ£ **LÃ³gica Backend**

#### FunciÃ³n `get_clientes_por_color(numero_aviso)`
- [x] Lee SHP del dÃ­a crÃ­tico âœ…
- [x] Convierte CRS UTM â†’ EPSG:4326 âœ…
- [x] Realiza spatial join con GeoPandas âœ…
- [x] Retorna `mapa_cliente_color: {id: 'roja'|'naranja'|'amarilla'|'sin_zona'}` âœ…
- [x] Manejo de errores con fallback âœ…

#### Endpoint `/api/avisos/<num>/resumen-zonas`
- [x] Lee SHP + Clientes BD âœ…
- [x] Obtiene TODOS los clientes âœ…
- [x] Obtiene clientes AFECTADOS (por depto CSV) âœ…
- [x] Cruza ambos usando `mapa_cliente_color` âœ…
- [x] Retorna estructura: `{roja: {...}, naranja: {...}, amarilla: {...}}` âœ…
- [x] Calcula: agr_totales, agr_afectados, ha_totales, ha_afectadas, monto_total, monto_afectado âœ…
- [x] Redondea decimales âœ…

#### Endpoint `/api/avisos/<num>/resumen-entidades`
- [x] Query: TODOS los clientes agrupados por depto/provincia âœ…
- [x] Query: AFECTADOS agrupados por depto/provincia âœ…
- [x] Merge de ambas queries âœ…
- [x] Calcula % damage: (afectados/totales) * 100 âœ…
- [x] Retorna estructura: `{departamentos: [{nombre, agr_totales, agr_afectados, ...}]}` âœ…

### 3ï¸âƒ£ **HTML**
- [x] Tabla Zonas agregada âœ…
- [x] Tabla Entidades agregada âœ…
- [x] IDs correctos: `#tabla-zonas-body`, `#tabla-entidades-body` âœ…
- [x] Bootstrap responsive (col-lg-6) âœ…
- [x] Headers con fondo oscuro âœ…
- [x] Ambas tablas FUERA del contenedor principal âœ…

### 4ï¸âƒ£ **CSS**
- [x] `.tabla-card` con shadow âœ…
- [x] `.tabla-header` con gradiente âœ…
- [x] `.zona-roja`, `.zona-naranja`, `.zona-amarilla` colores correctos âœ…
- [x] Hover effects en filas âœ…
- [x] Media queries para mobile âœ…

### 5ï¸âƒ£ **JavaScript**
- [x] FunciÃ³n `actualizarTablaZonas()` â†’ Fetch endpoint + renderiza âœ…
- [x] FunciÃ³n `actualizarTablaEntidades()` â†’ Fetch endpoint + renderiza âœ…
- [x] Ambas llamadas en `actualizarDatos()` âœ…
- [x] Ambas llamadas en `cargarAviso()` al inicializar âœ…
- [x] Formateo de nÃºmeros con `toLocaleString('es-ES')` âœ…
- [x] Manejo de errores con try-catch âœ…

---

## ğŸ“‹ FLUJO DE EJECUCIÃ“N ESPERADO

### Cuando usuario abre pÃ¡gina:
1. `initializeDecisiones()` â†’ inicializa mapa
2. `cargarAvisos()` â†’ carga lista de avisos en selector

### Cuando usuario selecciona aviso:
1. `cargarAviso()` ejecuta:
   - Fetch `/api/avisos/{num}/clientes-afectados`
   - Fetch `/api/avisos/{num}/estadisticas`
   - Fetch `/api/avisos/{num}/shp-geojson`
   - Fetch `/api/avisos/{num}/agregaciones`
2. Actualiza KPIs âœ…
3. Actualiza Tabla Zonas (llamando `/resumen-zonas`) âœ…
4. Actualiza Tabla Entidades (llamando `/resumen-entidades`) âœ…
5. Carga SHP en mapa âœ…
6. Carga clientes en mapa âœ…

### Cuando usuario cambia filtro (depto/provincia/distrito):
1. `actualizarDatos()` ejecuta:
   - Fetch `/api/avisos/{num}/clientes-afectados?depto=X&provincia=Y&distrito=Z`
   - Actualiza estadÃ­sticas dinÃ¡micas (panel derecho) âœ…
   - Actualiza Tabla Zonas (datos nacionales, no filtrados) âœ…
   - Actualiza Tabla Entidades (datos nacionales, no filtrados) âœ…

---

## âš ï¸ NOTAS IMPORTANTES

1. **Tablas muestran DATOS NACIONALES** no filtrados (asÃ­ como los KPIs superiores)
   - Las tablas siempre muestran el breakdown completo del aviso
   - Los filtros solo afectan al panel de estadÃ­sticas dinÃ¡micas (derecha)

2. **Spatial join** requiere que SHP tenga columna `nivel` con valores 'Nivel 1', 'Nivel 2', 'Nivel 3', 'Nivel 4'

3. **CSV avisos** debe existir en `OUTPUT/aviso_{numero}/distritos_afectados.csv` para que funcione

4. **BD clientes** debe tener registros con `latitud`, `longitud`, `estado='activo'`

---

## ğŸ¯ TESTING EN WEB

### Paso 1: Seleccionar un aviso (ej: 445)
- âœ… KPIs se actualizan (nÃºmeros superiores)
- âœ… Tabla Zonas aparece con datos de Roja/Naranja/Amarilla
- âœ… Tabla Entidades aparece con lista de departamentos
- âœ… Mapa muestra puntos GPS
- âœ… Mapa muestra SHP coloreado

### Paso 2: Cambiar filtro a un departamento
- âœ… Panel derecho (estadÃ­sticas) se actualiza
- âœ… Tablas se ACTUALIZAN (si filtros afectan las queries)

### Paso 3: Verificar formato de datos
- âœ… NÃºmeros con separador de miles: `1,234.56`
- âœ… Moneda en Soles: `S/ 1,234,567`
- âœ… Porcentajes: `37.5%`
- âœ… HectÃ¡reas: `234.56`

---

## ğŸš€ PRÃ“XIMOS PASOS

Si todo pasa:
1. âœ… Commit y push
2. âœ… Subir a servidor
3. âœ… Probar en navegador
4. âœ… Ajustar colores/estilos si es necesario

---

**Creado**: 2026-02-03  
**Estado**: LISTO PARA TESTING EN WEB âœ…
