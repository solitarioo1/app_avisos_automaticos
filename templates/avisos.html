{% extends "base.html" %}

{% block title %}Avisos - La Positiva AgroSeguros{% endblock %}

{% block content %}
<style>
    .nivel-badge { display: inline-block; padding: 0.35rem 0.75rem; border-radius: 4px; font-weight: 600; font-size: 12px; color: white; }
    .nivel-rojo { background: #dc3545; }
    .nivel-naranja { background: #ff8c00; }
    .nivel-amarillo { background: #ffc107; color: #333; }
    .nivel-verde { background: #198754; }
</style>

<div class="container-fluid px-5 py-4" style="max-width: 1400px; margin: 0 auto;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0"><i class="bi bi-cloud-lightning"></i> Gesti√≥n de Avisos</h2>
        <button class="btn btn-success btn-sm" id="btnConsultarNuevos" onclick="consultarNuevos()">
            <i class="bi bi-search"></i> üîç Consultar Avisos Nuevos
        </button>
    </div>

    <!-- Filtros -->
    <div class="card mb-3">
        <div class="card-body">
            <div class="row g-2">
                <div class="col-md-3">
                    <label class="form-label mb-1">üîç Buscar Aviso</label>
                    <input type="text" class="form-control form-control-sm" id="filtro-numero" placeholder="N√∫mero de aviso..." onkeyup="aplicarFiltros()">
                </div>
                <div class="col-md-3">
                    <label class="form-label mb-1">Nivel</label>
                    <select class="form-select form-select-sm" id="filtro-nivel" onchange="aplicarFiltros()">
                        <option value="">Todos</option>
                        <option value="rojo">üî¥ ROJO</option>
                        <option value="naranja">üü† NARANJA</option>
                        <option value="amarillo">üü° AMARILLO</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label mb-1">Ordenar</label>
                    <select class="form-select form-select-sm" id="filtro-orden" onchange="aplicarFiltros()">
                        <option value="desc">M√°s recientes ‚Üì</option>
                        <option value="asc">M√°s antiguos ‚Üë</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-sm btn-outline-secondary w-100" onclick="resetearFiltros()">
                        <i class="bi bi-arrow-clockwise"></i> Resetear Filtros
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla -->
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0" id="tabla-titulo">Lista de Avisos</h5>
        </div>
        <div class="table-responsive">
            <table class="table table-hover mb-0 table-sm">
                <thead class="table-light">
                    <tr>
                        <th style="width: 100px;">N√∫mero Aviso</th>
                        <th style="width: 35%;">T√≠tulo</th>
                        <th style="width: 100px;">Nivel</th>
                        <th style="width: 110px;">Fecha</th>
                        <th style="width: 85px;">Descargado</th>
                        <th style="width: 85px;">Mapa Creado</th>
                        <th style="width: 150px;">Acciones</th>
                    </tr>
                </thead>
                <tbody id="tabla-avisos">
                    <tr style="grid-column: 1/-1;">
                        <td colspan="7" class="text-center py-4">
                            <i class="bi bi-hourglass-split display-4 text-muted spin"></i>
                            <p class="text-muted mt-2">Cargando avisos...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let AVISOS_ORIGINALES = [];
    let avisoEspecifico = null;

    function obtenerParametroURL(nombre) {
        const params = new URLSearchParams(window.location.search);
        return params.get(nombre);
    }

    async function cargarAvisos() {
        try {
            avisoEspecifico = obtenerParametroURL('aviso');
            
            const res = await fetch('/api/avisos');
            const result = await res.json();
            let avisos = result.avisos || [];

            // Si viene con ?aviso=X, filtrar solo ese aviso
            if (avisoEspecifico) {
                avisos = avisos.filter(a => a.numero == avisoEspecifico);
                document.getElementById('tabla-titulo').textContent = `Aviso #${avisoEspecifico}`;
            }

            AVISOS_ORIGINALES = avisos.map(aviso => ({
                numero: aviso.numero,
                titulo: aviso.titulo,
                nivel: aviso.nivel ? aviso.nivel.toLowerCase() : 'amarillo',
                color: aviso.color || 'amarillo',
                fecha: aviso.fecha_emision,
                descargado: aviso.descargado,
                mapa_creado: aviso.mapa_creado
            }));

            if (AVISOS_ORIGINALES.length === 0) {
                document.getElementById('tabla-avisos').innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4 text-muted">
                            No hay avisos disponibles
                        </td>
                    </tr>
                `;
                return;
            }

            aplicarFiltros();
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('tabla-avisos').innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4 text-danger">Error cargando avisos</td>
                </tr>
            `;
        }
    }

    function aplicarFiltros() {
        const nivel = document.getElementById('filtro-nivel').value.toLowerCase();
        const orden = document.getElementById('filtro-orden').value;
        const numero = document.getElementById('filtro-numero').value.toLowerCase();

        let avisosFiltrados = AVISOS_ORIGINALES.filter(aviso => {
            const cumpleNivel = !nivel || aviso.nivel === nivel;
            const cumpleNumero = !numero || aviso.numero.toString().includes(numero);
            return cumpleNivel && cumpleNumero;
        });

        if (orden === 'asc') {
            avisosFiltrados.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
        } else {
            avisosFiltrados.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
        }

        const tbody = document.getElementById('tabla-avisos');
        let html = '';

        avisosFiltrados.forEach(aviso => {
            const colorBadge = aviso.color.charAt(0).toUpperCase() + aviso.color.slice(1);
            html += `
                <tr data-numero="${aviso.numero}" data-nivel="${aviso.nivel}" data-fecha="${aviso.fecha}" data-color="${aviso.color}">
                    <td><strong>#${aviso.numero}</strong></td>
                    <td style="text-align: left;">${aviso.titulo}</td>
                    <td>
                        <span class="nivel-badge nivel-${aviso.color}">
                            ${aviso.color.toUpperCase()}
                        </span>
                    </td>
                    <td><small>${aviso.fecha}</small></td>
                    <td style="text-align: center;">${aviso.descargado}</td>
                    <td style="text-align: center;">${aviso.mapa_creado}</td>
                    <td>
                        <div class="acciones-col" style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-sm btn-outline-primary btn-descargar" title="Descargar JSON" data-numero="${aviso.numero}">
                                <i class="bi bi-download"></i>
                            </button>
                            <a href="/mapas?aviso=${aviso.numero}" class="btn btn-sm btn-outline-secondary" title="Ver Mapas">
                                <i class="bi bi-eye"></i>
                            </a>
                            <a href="/decisiones?aviso=${aviso.numero}" class="btn btn-sm btn-outline-warning" title="Decisiones">
                                <i class="bi bi-geo"></i>
                            </a>
                        </div>
                    </td>
                </tr>
            `;
        });

        tbody.innerHTML = html || `<tr><td colspan="7" class="text-center py-4 text-muted">No hay resultados</td></tr>`;

        // Agregar eventos de descarga
        document.querySelectorAll('.btn-descargar').forEach(btn => {
            btn.addEventListener('click', descargarAviso);
        });
    }

    function resetearFiltros() {
        if (avisoEspecifico) {
            window.location.href = '/avisos';
            return;
        }
        document.getElementById('filtro-numero').value = '';
        document.getElementById('filtro-nivel').value = '';
        document.getElementById('filtro-orden').value = 'desc';
        aplicarFiltros();
    }

    async function descargarAviso() {
        const numero = this.getAttribute('data-numero');
        const btnIcon = this.querySelector('i');
        const originalClass = btnIcon.className;

        try {
            this.disabled = true;
            btnIcon.className = 'bi bi-hourglass-split spin';

            const response = await fetch(`/api/avisos/${numero}/descargar`, { method: 'POST' });
            const data = await response.json();

            if (response.ok) {
                btnIcon.className = 'bi bi-check-circle';
                this.classList.remove('btn-outline-primary');
                this.classList.add('btn-success');
                setTimeout(() => location.reload(), 1000);
            } else {
                alert('Error: ' + data.error);
                btnIcon.className = originalClass;
                this.disabled = false;
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al descargar: ' + error.message);
            btnIcon.className = originalClass;
            this.disabled = false;
        }
    }

    async function consultarNuevos() {
        const btn = document.getElementById('btnConsultarNuevos');
        const originalHTML = btn.innerHTML;

        try {
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-hourglass-split spin"></i> Consultando...';

            const response = await fetch('/api/avisos/nuevos');
            const data = await response.json();

            if (data.status === 'success') {
                const total = data.total_nuevos;
                if (total > 0) {
                    alert(`‚úÖ Se encontraron ${total} aviso(s) nuevo(s)`);
                } else {
                    alert('‚ÑπÔ∏è Por el momento no hay avisos nuevos');
                }
            } else {
                alert('‚ùå Error: ' + data.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('‚ùå Error: ' + error.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalHTML;
        }
    }

    // Spin animation
    const style = document.createElement('style');
    style.textContent = `.spin { display: inline-block; animation: spin 1s linear infinite; } @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }`;
    document.head.appendChild(style);

    // Esperar a que el DOM est√© listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', cargarAvisos);
    } else {
        cargarAvisos();
    }
</script>

{% endblock %}
