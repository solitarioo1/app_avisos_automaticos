{% extends "base.html" %}

{% block title %}Toma de Decisiones - La Positiva AgroSeguros{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <!-- Header de La Positiva AgroSeguros -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-warning">
                <div class="card-header text-white" style="background: linear-gradient(135deg, #e53935, #c62828);">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-0">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                Centro de Decisiones Estratégicas
                            </h3>
                            <small class="opacity-75">La Positiva AgroSeguros - Sistema de Evaluación de Riesgos Meteorológicos</small>
                        </div>
                        <div class="text-end">
                            <div class="badge bg-warning text-dark fs-6 mb-1">
                                ALERTAS ACTIVAS
                            </div>
                            <br>
                            <small id="fecha-actual"></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Estado Actual del Sistema -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center bg-danger text-white">
                <div class="card-body">
                    <i class="bi bi-exclamation-triangle display-4"></i>
                    <h5 class="mt-2">CRÍTICO</h5>
                    <p class="mb-0">3 departamentos</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-warning text-dark">
                <div class="card-body">
                    <i class="bi bi-shield-exclamation display-4"></i>
                    <h5 class="mt-2">ALTO RIESGO</h5>
                    <p class="mb-0">7 departamentos</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-info text-white">
                <div class="card-body">
                    <i class="bi bi-people-fill display-4"></i>
                    <h5 class="mt-2">AGRICULTORES</h5>
                    <p class="mb-0">15,847 afectados</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-success text-white">
                <div class="card-body">
                    <i class="bi bi-cash-coin display-4"></i>
                    <h5 class="mt-2">PÓLIZAS</h5>
                    <p class="mb-0">S/ 245M en riesgo</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Mapa Interactivo -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-map"></i> Mapa Nacional de Impacto - Perú
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div id="mapa-peru-decisiones" style="height: 400px; background: linear-gradient(135deg, #e8f5e8, #c8e6c9); position: relative; overflow: hidden;">
                        <!-- Título del mapa -->
                        <div style="position: absolute; top: 20px; left: 20px; z-index: 100;">
                            <div class="badge bg-warning text-dark">NIVEL AMARILLO</div>
                            <div class="badge bg-info ms-1">85% Probabilidad</div>
                        </div>
                        
                        <!-- Departamentos simulados -->
                        <div class="departamento-item" data-dept="Piura" style="position: absolute; top: 20%; left: 12%; width: 80px; height: 60px; background: rgba(244, 67, 54, 0.8); border: 3px solid #f44336; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 10px;">
                            PIURA<br><small>1,156 Agr.</small>
                        </div>
                        
                        <div class="departamento-item" data-dept="Lima" style="position: absolute; top: 45%; left: 15%; width: 85px; height: 65px; background: rgba(255, 193, 7, 0.8); border: 3px solid #ffc107; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #333; font-size: 11px;">
                            LIMA<br><small>1,247 Agr.</small>
                        </div>
                        
                        <div class="departamento-item" data-dept="Arequipa" style="position: absolute; top: 68%; left: 28%; width: 80px; height: 60px; background: rgba(255, 152, 0, 0.8); border: 3px solid #ff9800; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #333; font-size: 10px;">
                            AREQUIPA<br><small>689 Agr.</small>
                        </div>
                        
                        <!-- Leyenda -->
                        <div style="position: absolute; bottom: 15px; left: 15px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h6 class="mb-2">Nivel de Riesgo</h6>
                            <div class="mb-2">
                                <span style="display: inline-block; width: 18px; height: 18px; background: #f44336; border-radius: 4px;"></span> 
                                <small><strong>CRÍTICO</strong> (>1000 agr.)</small>
                            </div>
                            <div class="mb-2">
                                <span style="display: inline-block; width: 18px; height: 18px; background: #ff9800; border-radius: 4px;"></span> 
                                <small><strong>ALTO</strong> (500-1000)</small>
                            </div>
                            <div class="mb-2">
                                <span style="display: inline-block; width: 18px; height: 18px; background: #ffc107; border-radius: 4px;"></span> 
                                <small><strong>MEDIO</strong> (<500 agr.)</small>
                            </div>
                            <hr class="my-2">
                            <small class="text-muted">📍 Click en departamento para detalles</small>
                        </div>
                        
                        <!-- Información hover -->
                        <div id="dept-tooltip-decisiones" style="position: absolute; background: rgba(0,0,0,0.9); color: white; padding: 12px; border-radius: 8px; font-size: 12px; display: none; z-index: 1000; pointer-events: none; max-width: 250px;"></div>
                    </div>
                    
                    <!-- Controles del mapa -->
                    <div class="p-3 border-top">
                        <div class="row">
                            <div class="col-md-8">
                                <button class="btn btn-primary btn-sm me-2" onclick="resetMapaDecisiones()">🔄 Vista General</button>
                                <button class="btn btn-info btn-sm me-2" onclick="toggleProvinciasDecisiones()">🏛️ Nivel Provincial</button>
                                <button class="btn btn-success btn-sm me-2" onclick="exportarMapaDecisiones()">📊 Generar Reporte</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Panel de Control -->
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-exclamation-triangle"></i> Centro de Comando
                    </h5>
                </div>
                <div class="card-body" style="background: #f8f9fa;">
                    <!-- Información del departamento seleccionado -->
                    <div id="dept-detail-decisiones" class="mb-4">
                        <h6 class="text-primary">📍 Información Regional</h6>
                        <div class="alert alert-info py-2 px-3">
                            <small>Seleccione un departamento en el mapa para ver análisis detallado</small>
                        </div>
                    </div>
                    
                    <!-- Acciones de Emergencia -->
                    <div class="mb-4">
                        <h6 class="text-danger">🚨 Protocolos de Emergencia</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-danger btn-sm" onclick="activarBrigadas()">
                                <i class="bi bi-people-fill"></i> Activar Brigadas
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="notificarAutoridades()">
                                <i class="bi bi-megaphone"></i> Notificar Autoridades
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Análisis de Cultivos por Región -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-bar-chart-line"></i> Análisis de Exposición por Cultivos
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <canvas id="cultivosChart" width="400" height="200"></canvas>
                        </div>
                        <div class="col-md-6">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Cultivo</th>
                                            <th>Hectáreas</th>
                                            <th>Valor Asegurado</th>
                                            <th>Riesgo</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>🌾 Arroz</td>
                                            <td>12,450</td>
                                            <td>S/ 89.2M</td>
                                            <td><span class="badge bg-danger">Alto</span></td>
                                        </tr>
                                        <tr>
                                            <td>🌽 Maíz</td>
                                            <td>8,890</td>
                                            <td>S/ 67.8M</td>
                                            <td><span class="badge bg-warning">Medio</span></td>
                                        </tr>
                                        <tr>
                                            <td>🥔 Papa</td>
                                            <td>15,670</td>
                                            <td>S/ 124.5M</td>
                                            <td><span class="badge bg-danger">Crítico</span></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Acciones Estratégicas -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-lightning"></i> Acciones Inmediatas
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-3">
                        <button class="btn btn-outline-danger" onclick="enviarAlertaWhatsApp()">
                            <i class="bi bi-whatsapp"></i> Enviar Alerta WhatsApp
                        </button>
                        <button class="btn btn-outline-warning" onclick="activarEquiposTecnicos()">
                            <i class="bi bi-tools"></i> Activar Equipos Técnicos
                        </button>
                        <button class="btn btn-outline-info" onclick="generarReporteCompleto()">
                            <i class="bi bi-file-earmark-pdf"></i> Generar Reporte PDF
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history"></i> Historial de Decisiones
                    </h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <div class="d-flex mb-3">
                            <div class="flex-shrink-0">
                                <span class="badge bg-danger">14:30</span>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <small><strong>Alerta enviada</strong> a 1,247 agricultores en Lima</small>
                            </div>
                        </div>
                        <div class="d-flex mb-3">
                            <div class="flex-shrink-0">
                                <span class="badge bg-warning">13:45</span>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <small><strong>Brigadas activadas</strong> en Piura</small>
                            </div>
                        </div>
                        <div class="d-flex mb-3">
                            <div class="flex-shrink-0">
                                <span class="badge bg-info">13:20</span>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <small><strong>Reporte generado</strong> para autoridades regionales</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script src="{{ url_for('static', filename='js/decisiones.js') }}"></script>
{% endblock %}
</body>
</html>
