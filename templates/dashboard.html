{% extends "base.html" %}

{% block content %}
<div class="dashboard-header">
    <h1><i class="bi bi-speedometer2"></i> Dashboard Principal</h1>
    <p class="text-muted">Sistema de Gesti√≥n de Avisos Meteorol√≥gicos para Agricultores</p>
</div>

<!-- Estad√≠sticas R√°pidas -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stat-card stat-primary">
            <div class="card-body">
                <div class="stat-icon">
                    <i class="bi bi-cloud-lightning"></i>
                </div>
                <div class="stat-info">
                    <h3 id="avisos-activos">{{ stats.avisos_activos or 0 }}</h3>
                    <p>Avisos Activos</p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card stat-warning">
            <div class="card-body">
                <div class="stat-icon">
                    <i class="bi bi-geo-alt"></i>
                </div>
                <div class="stat-info">
                    <h3 id="departamentos-afectados">{{ stats.departamentos_afectados or 0 }}</h3>
                    <p>Departamentos Afectados</p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card stat-danger">
            <div class="card-body">
                <div class="stat-icon">
                    <i class="bi bi-people"></i>
                </div>
                <div class="stat-info">
                    <h3 id="agricultores-afectados">{{ "{:,}".format(stats.agricultores_afectados) if stats.agricultores_afectados else "0" }}</h3>
                    <p>Agricultores Afectados</p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card stat-info">
            <div class="card-body">
                <div class="stat-icon">
                    <i class="bi bi-tree"></i>
                </div>
                <div class="stat-info">
                    <h3 id="cultivos-riesgo">{{ stats.cultivos_riesgo or 0 }}</h3>
                    <p>Cultivos en Riesgo</p>
                </div>
            </div>
        </div>
    </div>
</div>

{% if evento_actual %}
<!-- Informaci√≥n del Evento Actual -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-left-warning">
            <div class="card-header" style="background: linear-gradient(135deg, #f39c12, #e67e22); color: white;">
                <h5 class="mb-0">
                    <i class="bi bi-cloud-rain"></i> 
                    Evento Meteorol√≥gico Actual
                    <span class="badge bg-dark ms-2">{{ evento_actual.nivel_alerta }}</span>
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-8">
                        <h6 class="text-primary">{{ evento_actual.titulo }}</h6>
                        <p class="mb-2"><strong>Tipo:</strong> {{ evento_actual.tipo }}</p>
                        <p class="mb-2"><strong>Vigencia:</strong> {{ evento_actual.vigencia }}</p>
                        <p class="mb-2"><strong>Intensidad:</strong> {{ evento_actual.intensidad }}</p>
                        <p class="mb-3">{{ evento_actual.descripcion }}</p>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h6>üó∫Ô∏è Departamentos Afectados ({{ evento_actual.departamentos_afectados|length }}):</h6>
                                <div class="d-flex flex-wrap gap-1 mb-3">
                                    {% for dept in evento_actual.departamentos_afectados %}
                                    <span class="badge bg-secondary">{{ dept }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>üåæ Cultivos en Riesgo ({{ evento_actual.cultivos_riesgo|length }}):</h6>
                                <div class="d-flex flex-wrap gap-1 mb-3">
                                    {% for cultivo in evento_actual.cultivos_riesgo %}
                                    <span class="badge bg-success">{{ cultivo }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="text-center">
                            <h6>Probabilidad del Evento</h6>
                            <div class="progress mb-3" style="height: 25px;">
                                <div class="progress-bar" role="progressbar" 
                                     style="width: {{ evento_actual.probabilidad }}%; background: linear-gradient(45deg, #f39c12, #e67e22);" 
                                     aria-valuenow="{{ evento_actual.probabilidad }}" 
                                     aria-valuemin="0" aria-valuemax="100">
                                    {{ evento_actual.probabilidad }}%
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <h6>üìä Resumen Ejecutivo</h6>
                                <div class="row text-center">
                                    <div class="col-4">
                                        <div class="border rounded p-2" style="border-color: #f39c12 !important;">
                                            <strong style="color: #f39c12;">{{ stats.departamentos_afectados }}</strong>
                                            <br><small>Departamentos</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="border rounded p-2" style="border-color: #e74c3c !important;">
                                            <strong style="color: #e74c3c;">{{ "{:,}".format(stats.agricultores_afectados) if stats.agricultores_afectados else "0" }}</strong>
                                            <br><small>Agricultores</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="border rounded p-2" style="border-color: #3498db !important;">
                                            <strong style="color: #3498db;">{{ stats.cultivos_riesgo }}</strong>
                                            <br><small>Cultivos</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Procesamiento de Avisos -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-gear"></i> Procesamiento de Avisos</h5>
            </div>
            <div class="card-body">
                <form id="form-procesar-aviso">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="numero_aviso" class="form-label">N√∫mero de Aviso</label>
                                <input type="number" class="form-control" id="numero_aviso" name="numero_aviso" placeholder="Ej: 12" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="origen" class="form-label">Origen</label>
                                <select class="form-select" id="origen" name="origen" required>
                                    <option value="">Seleccionar...</option>
                                    <option value="manual">Manual</option>
                                    <option value="n8n">n8n Webhook</option>
                                    <option value="api">API Externa</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-play-circle"></i> Procesar Aviso
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
                
                <!-- Progreso de procesamiento -->
                <div id="progreso-procesamiento" class="mt-3" style="display: none;">
                    <div class="progress mb-2">
                        <div id="barra-progreso" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                    <small id="estado-procesamiento" class="text-muted">Iniciando procesamiento...</small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-broadcast"></i> Estado n8n</h5>
            </div>
            <div class="card-body text-center">
                <div class="mb-3">
                    <div class="status-indicator status-success"></div>
                    <div class="mt-2">
                        <strong>Conectado</strong><br>
                        <span>n8n Webhooks</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Avisos Recientes y Mapas -->
<div class="row">
    <div class="col-md-7">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-list-ul"></i> Avisos Recientes</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Aviso</th>
                                <th>Fecha</th>
                                <th>Departamentos</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for aviso in avisos_recientes %}
                            <tr>
                                <td><strong>#{{ aviso.numero }}</strong></td>
                                <td>{{ aviso.fecha }}</td>
                                <td>{{ aviso.departamentos }}</td>
                                <td>
                                    <span class="badge bg-{{ aviso.estado_color }}">
                                        {{ aviso.estado }}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="verAviso({{ aviso.numero }})">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center text-muted">No hay avisos procesados</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-5">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-map"></i> Mapas Generados</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for mapa in mapas_recientes %}
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <img src="{{ mapa.thumbnail }}" class="card-img-top" alt="{{ mapa.nombre }}" style="height: 100px; object-fit: cover;">
                            <div class="card-body p-2">
                                <h6 class="card-title small">{{ mapa.nombre }}</h6>
                                <small class="text-muted">Aviso #{{ mapa.numero_aviso }}</small>
                                <div class="mt-2">
                                    <a href="{{ mapa.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="col-12">
                        <div class="text-center text-muted">
                            <i class="bi bi-map fa-3x mb-3"></i>
                            <p>No hay mapas generados</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Auto-refresh de estad√≠sticas cada 30 segundos
setInterval(function() {
    fetch('/api/stats')
        .then(response => response.json())
        .then(data => {
            updateDashboardStats(data);
        })
        .catch(error => console.error('Error:', error));
}, 30000);

function updateDashboardStats(data) {
    // Actualizar estad√≠sticas b√°sicas
    if (document.getElementById('avisos-activos')) {
        document.getElementById('avisos-activos').textContent = data.avisos_activos || 0;
    }
    if (document.getElementById('departamentos-afectados')) {
        document.getElementById('departamentos-afectados').textContent = data.departamentos_afectados || 0;
    }
    if (document.getElementById('agricultores-afectados')) {
        document.getElementById('agricultores-afectados').textContent = data.agricultores_afectados ? data.agricultores_afectados.toLocaleString() : '0';
    }
    if (document.getElementById('cultivos-riesgo')) {
        document.getElementById('cultivos-riesgo').textContent = data.cultivos_riesgo || 0;
    }
}

// Manejar formulario de procesamiento
document.getElementById('form-procesar-aviso').addEventListener('submit', function(e) {
    e.preventDefault();
    procesarAviso();
});

function procesarAviso() {
    const formData = new FormData(document.getElementById('form-procesar-aviso'));
    const numeroAviso = formData.get('numero_aviso');
    const origen = formData.get('origen');
    
    mostrarProgreso();
    
    fetch('/api/procesar-aviso', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            numero_aviso: parseInt(numeroAviso),
            origen: origen
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            actualizarProgreso(100, 'Procesamiento completado exitosamente');
            setTimeout(() => {
                ocultarProgreso();
                location.reload();
            }, 2000);
        } else {
            actualizarProgreso(100, 'Error en el procesamiento: ' + data.error);
        }
    })
    .catch(error => {
        actualizarProgreso(100, 'Error de conexi√≥n');
        console.error('Error:', error);
    });
}

function mostrarProgreso() {
    document.getElementById('progreso-procesamiento').style.display = 'block';
    actualizarProgreso(10, 'Iniciando procesamiento...');
    
    // Simular progreso
    setTimeout(() => actualizarProgreso(30, 'Descargando datos...'), 1000);
    setTimeout(() => actualizarProgreso(60, 'Procesando mapas...'), 3000);
    setTimeout(() => actualizarProgreso(90, 'Finalizando...'), 5000);
}

function actualizarProgreso(porcentaje, mensaje) {
    const barra = document.getElementById('barra-progreso');
    const estado = document.getElementById('estado-procesamiento');
    
    barra.style.width = porcentaje + '%';
    barra.setAttribute('aria-valuenow', porcentaje);
    estado.textContent = mensaje;
}

function ocultarProgreso() {
    document.getElementById('progreso-procesamiento').style.display = 'none';
}

function verAviso(numero) {
    window.location.href = `/avisos/${numero}`;
}

// FUNCIONALIDAD MAPA INTERACTIVO
const departamentosData = {
    'Lima': {
        agricultores: 1247,
        cultivos: ['Algod√≥n', 'Ma√≠z', 'Frijol', 'Camote'],
        perdidas: 'S/ 18.4M',
        polizas: 892,
        provincias: ['Lima', 'Huaral', 'Ca√±ete', 'Barranca'],
        riesgo: 'ALTO'
    },
    'Arequipa': {
        agricultores: 689,
        cultivos: ['Quinua', 'Papa', 'Cebada', 'Alfalfa'],
        perdidas: 'S/ 8.7M',
        polizas: 456,
        provincias: ['Arequipa', 'Caman√°', 'Caylloma'],
        riesgo: 'MEDIO'
    },
    'Cusco': {
        agricultores: 892,
        cultivos: ['Papa', 'Ma√≠z', 'Quinua', 'Caf√©'],
        perdidas: 'S/ 12.1M',
        polizas: 634,
        provincias: ['Cusco', 'La Convenci√≥n', 'Urubamba'],
        riesgo: 'ALTO'
    },
    'Piura': {
        agricultores: 1156,
        cultivos: ['Arroz', 'Algod√≥n', 'Mango', 'Lim√≥n'],
        perdidas: 'S/ 15.8M',
        polizas: 823,
        provincias: ['Piura', 'Sullana', 'Paita', 'Morrop√≥n'],
        riesgo: 'CR√çTICO'
    },
    'La Libertad': {
        agricultores: 734,
        cultivos: ['Ca√±a de Az√∫car', 'Arroz', 'Ma√≠z'],
        perdidas: 'S/ 9.2M',
        polizas: 521,
        provincias: ['Trujillo', 'Ascope', 'Chep√©n'],
        riesgo: 'MEDIO'
    },
    'Lambayeque': {
        agricultores: 456,
        cultivos: ['Arroz', 'Ca√±a de Az√∫car', 'Algod√≥n'],
        perdidas: 'S/ 6.1M',
        polizas: 324,
        provincias: ['Chiclayo', 'Lambayeque', 'Ferre√±afe'],
        riesgo: 'MEDIO'
    },
    'Ica': {
        agricultores: 523,
        cultivos: ['Uva', 'Palta', 'Esp√°rrago', 'Algod√≥n'],
        perdidas: 'S/ 7.3M',
        polizas: 387,
        provincias: ['Ica', 'Chincha', 'Pisco', 'Nazca'],
        riesgo: 'MEDIO'
    }
};

// Event listeners para departamentos
document.addEventListener('DOMContentLoaded', function() {
    const departamentos = document.querySelectorAll('.departamento-item');
    const tooltip = document.getElementById('dept-tooltip');
    const detailPanel = document.getElementById('dept-detail');
    
    if (departamentos.length > 0) {
        departamentos.forEach(dept => {
            // Hover effects
            dept.addEventListener('mouseenter', function(e) {
                const deptName = this.dataset.dept;
                const data = departamentosData[deptName];
                
                if (data && tooltip) {
                    tooltip.innerHTML = `
                        <strong>${deptName}</strong><br>
                        Agricultores: ${data.agricultores}<br>
                        P√©rdidas: ${data.perdidas}<br>
                        Riesgo: ${data.riesgo}
                    `;
                    tooltip.style.display = 'block';
                }
                
                this.style.transform = 'scale(1.1)';
                this.style.zIndex = '200';
            });
            
            dept.addEventListener('mouseleave', function(e) {
                if (tooltip) {
                    tooltip.style.display = 'none';
                }
                this.style.transform = 'scale(1)';
                this.style.zIndex = 'auto';
            });
            
            dept.addEventListener('mousemove', function(e) {
                if (tooltip) {
                    const rect = document.getElementById('mapa-peru').getBoundingClientRect();
                    tooltip.style.left = (e.clientX - rect.left + 10) + 'px';
                    tooltip.style.top = (e.clientY - rect.top - 10) + 'px';
                }
            });
            
            // Click para zoom y detalles
            dept.addEventListener('click', function() {
                const deptName = this.dataset.dept;
                mostrarDetallesDepartamento(deptName);
                
                // Visual feedback
                departamentos.forEach(d => d.style.borderColor = d.style.borderColor.replace('4px', '2px'));
                this.style.borderWidth = '4px';
                this.style.borderColor = '#007bff';
            });
        });
    }
});

function mostrarDetallesDepartamento(deptName) {
    const data = departamentosData[deptName];
    const detailPanel = document.getElementById('dept-detail');
    
    if (data && detailPanel) {
        detailPanel.innerHTML = `
            <h6 class="text-primary">üìç ${deptName} - An√°lisis Detallado</h6>
            <div class="row mb-2">
                <div class="col-6">
                    <div class="bg-white p-2 rounded text-center">
                        <strong>${data.agricultores}</strong><br>
                        <small>Agricultores</small>
                    </div>
                </div>
                <div class="col-6">
                    <div class="bg-white p-2 rounded text-center">
                        <strong>${data.polizas}</strong><br>
                        <small>P√≥lizas</small>
                    </div>
                </div>
            </div>
            <div class="mb-2">
                <strong>üí∞ P√©rdidas Estimadas:</strong> <span class="text-danger">${data.perdidas}</span>
            </div>
            <div class="mb-2">
                <strong>üåæ Cultivos Principales:</strong><br>
                ${data.cultivos.map(c => `<span class="badge bg-success me-1">${c}</span>`).join('')}
            </div>
            <div class="mb-2">
                <strong>üèõÔ∏è Provincias:</strong><br>
                ${data.provincias.map(p => `<span class="badge bg-info me-1">${p}</span>`).join('')}
            </div>
            <div class="alert alert-${data.riesgo === 'CR√çTICO' ? 'danger' : data.riesgo === 'ALTO' ? 'warning' : 'info'} py-2 px-3 mb-0">
                <strong>Nivel de Riesgo: ${data.riesgo}</strong>
            </div>
        `;
    }
}

function resetMapa() {
    const departamentos = document.querySelectorAll('.departamento-item');
    departamentos.forEach(d => {
        d.style.borderWidth = '2px';
        d.style.transform = 'scale(1)';
    });
    
    const detailPanel = document.getElementById('dept-detail');
    if (detailPanel) {
        detailPanel.innerHTML = `
            <h6 class="text-primary">üìç Informaci√≥n Detallada</h6>
            <div class="alert alert-info py-2 px-3">
                <small>Haz clic en un departamento para ver detalles espec√≠ficos</small>
            </div>
        `;
    }
}

function toggleProvincias() {
    alert('üèõÔ∏è Vista de provincias - Funcionalidad en desarrollo\\n\\nPermitir√° ver divisi√≥n provincial con:\\n‚Ä¢ Agricultores por provincia\\n‚Ä¢ Cultivos espec√≠ficos\\n‚Ä¢ Estimaci√≥n de p√©rdidas\\n‚Ä¢ Tiempo de respuesta');
}

function exportarMapa() {
    alert('üì• Exportando mapa...\\n\\nSe generar√° un reporte PDF con:\\n‚Ä¢ Mapa de situaci√≥n actual\\n‚Ä¢ Datos por departamento\\n‚Ä¢ An√°lisis de riesgos\\n‚Ä¢ Recomendaciones');
}

function activarProtocoloEmergencia() {
    if (confirm('üö® ¬øConfirma activar el Protocolo de Emergencia?\\n\\nEsto iniciar√°:\\n‚Ä¢ Notificaci√≥n a brigadas\\n‚Ä¢ Activaci√≥n de equipos\\n‚Ä¢ Comunicaci√≥n con autoridades\\n‚Ä¢ Monitoreo 24/7')) {
        alert('‚úÖ Protocolo de Emergencia ACTIVADO\\n\\nEquipos notificados y en camino a las zonas afectadas.');
    }
}

function generarReporte() {
    alert('üìã Generando Reporte Ejecutivo...\\n\\n‚úÖ Resumen de impacto\\n‚úÖ An√°lisis financiero\\n‚úÖ Recomendaciones\\n‚úÖ Plan de acci√≥n\\n\\nEl reporte estar√° listo en 2 minutos.');
}

function notificarEquipos() {
    alert('üì± Notificando equipos de campo...\\n\\n‚úÖ WhatsApp enviado a supervisores\\n‚úÖ Email a gerentes regionales\\n‚úÖ SMS a brigadistas\\n\\nTodos los equipos han sido alertados.');
}
</script>
{% endblock %}