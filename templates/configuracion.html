{% extends "base.html" %}

{% block content %}
<div class="dashboard-header">
    <h1><i class="bi bi-gear"></i> Configuración del Sistema</h1>
    <p class="text-muted">Configuración de conexiones, parámetros y preferencias</p>
</div>

<div class="row">
    <!-- Configuración Base de Datos -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-database"></i> Base de Datos</h5>
            </div>
            <div class="card-body">
                <form id="config-bd">
                    <div class="mb-3">
                        <label class="form-label">Host</label>
                        <input type="text" class="form-control" id="db_host" placeholder="localhost">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Puerto</label>
                        <input type="number" class="form-control" id="db_port" value="5432">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Base de Datos</label>
                        <input type="text" class="form-control" id="db_name" placeholder="database_avisos">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Usuario</label>
                        <input type="text" class="form-control" id="db_user" placeholder="usuario">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Contraseña</label>
                        <input type="password" class="form-control" id="db_password" placeholder="********">
                    </div>
                    <button type="button" class="btn btn-outline-info me-2" onclick="testearConexion()">
                        <i class="bi bi-plug"></i> Testear Conexión
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> Guardar
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Configuración WhatsApp -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-whatsapp"></i> WhatsApp API</h5>
            </div>
            <div class="card-body">
                <form id="config-whatsapp">
                    <div class="mb-3">
                        <label class="form-label">API URL</label>
                        <input type="url" class="form-control" id="wa_api_url" placeholder="https://api.whatsapp.com">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Token</label>
                        <input type="text" class="form-control" id="wa_token" placeholder="Token API">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Instancia</label>
                        <input type="text" class="form-control" id="wa_instance" placeholder="instancia">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="wa_active">
                            <label class="form-check-label" for="wa_active">
                                Activar envío automático
                            </label>
                        </div>
                    </div>
                    <button type="button" class="btn btn-outline-info me-2" onclick="testearWhatsApp()">
                        <i class="bi bi-phone"></i> Testear API
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-save"></i> Guardar
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <!-- Configuración n8n -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-diagram-3"></i> n8n Webhooks</h5>
            </div>
            <div class="card-body">
                <form id="config-n8n">
                    <div class="mb-3">
                        <label class="form-label">URL Base n8n</label>
                        <input type="url" class="form-control" id="n8n_url" 
                               value="https://paneln8n.miagentepersonal.me">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Webhook Procesar Avisos</label>
                        <input type="text" class="form-control" id="n8n_webhook_procesar" 
                               value="/webhook/procesar-avisos">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Webhook WhatsApp</label>
                        <input type="text" class="form-control" id="n8n_webhook_whatsapp" 
                               value="/webhook/whatsapp">
                    </div>
                    <button type="button" class="btn btn-outline-info me-2" onclick="testearN8n()">
                        <i class="bi bi-arrow-repeat"></i> Testear Webhooks
                    </button>
                    <button type="submit" class="btn btn-info">
                        <i class="bi bi-save"></i> Guardar
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Configuración General -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-sliders"></i> Configuración General</h5>
            </div>
            <div class="card-body">
                <form id="config-general">
                    <div class="mb-3">
                        <label class="form-label">Dominio Público</label>
                        <input type="url" class="form-control" id="domain" 
                               value="https://mapas.miagentepersonal.me">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Intervalo Auto-refresh (seg)</label>
                        <input type="number" class="form-control" id="refresh_interval" value="30" min="10">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Directorio de Output</label>
                        <input type="text" class="form-control" id="output_dir" value="OUTPUT" readonly>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="debug_mode">
                            <label class="form-check-label" for="debug_mode">
                                Modo Debug
                            </label>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> Guardar Configuración
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function testearConexion() {
    fetch('/api/test-db', { method: 'POST' })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            SENAMHI.showNotification('Conexión a BD exitosa', 'success');
        } else {
            SENAMHI.showNotification('Error conexión BD: ' + data.message, 'danger');
        }
    });
}

function testearWhatsApp() {
    fetch('/api/test-whatsapp', { method: 'POST' })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            SENAMHI.showNotification('WhatsApp API conectado', 'success');
        } else {
            SENAMHI.showNotification('Error WhatsApp: ' + data.message, 'danger');
        }
    });
}

function testearN8n() {
    fetch('/api/test-n8n', { method: 'POST' })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            SENAMHI.showNotification('n8n webhooks funcionando', 'success');
        } else {
            SENAMHI.showNotification('Error n8n: ' + data.message, 'danger');
        }
    });
}

// Manejar envío de formularios
document.querySelectorAll('form').forEach(form => {
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        guardarConfiguracion(this.id);
    });
});

function guardarConfiguracion(formId) {
    const formData = new FormData(document.getElementById(formId));
    const data = Object.fromEntries(formData);
    
    fetch('/api/save-config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ section: formId, data: data })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            SENAMHI.showNotification('Configuración guardada', 'success');
        } else {
            SENAMHI.showNotification('Error guardando: ' + data.message, 'danger');
        }
    });
}
</script>
{% endblock %}